version: '3.8'

services:
  devbuddy:
    image: devbuddy:dev
    container_name: devbuddy-server
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "5000:8080"
      - "5001:8081"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_HTTP_PORTS=8080
      - ASPNETCORE_HTTPS_PORTS=8081
      - CODE_BASE_PATH=/workspace
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/aspnetapp.pfx
      - ASPNETCORE_Kestrel__Certificates__Default__Password=DevCertPassword
      # Git authentication (optional - use .env file or set these manually)
      # Empty defaults allow optional configuration. See .env.example for format.
      - GIT_USERNAME=${GIT_USERNAME:-}
      - GITHUB_PAT=${GITHUB_PAT:-}
      - AZDO_PAT=${AZDO_PAT:-}
    volumes:
      # Mount the sample codebase into the container
      # Note: Read-write mount for development (allows agent to create/modify files)
      # For production, use :ro flag for read-only security
      - ./sample-codebase:/workspace
      # Volume for persisting HTTPS certificate across container restarts
      - https-certs:/https
      # Optional: Mount local dev cert from host machine
      # Uncomment to use your local machine's dev cert instead of container-generated cert
      - ~/.aspnet/https:/https-host:ro
      # Optional: Mount git credentials file directly (alternative to environment variables)
      # Uncomment to use a pre-configured git credentials file instead of GITHUB_PAT/AZDO_PAT
      # - ~/.git-credentials:/home/vscode/.git-credentials:ro
    networks:
      - mcp-network
    # Security options
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - DAC_OVERRIDE
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          memory: 512M
    # Restart policy for OOM
    restart: unless-stopped

networks:
  mcp-network:
    driver: bridge

volumes:
  https-certs:
    name: devbuddy-certs
